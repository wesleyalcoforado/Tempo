<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <script>    
        function updateWeather(){
            var city = getCity();
            if(city == null || city.trim().length == 0){
                return;
            }

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function(data) {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        var data = xhr.responseXML;
                        parseWeather(data);
                    } else {
                        parseWeather(null);
                    }
                }
            }  

	        var url = 'http://www.google.com/ig/api?weather=' + city + '&hl=pt-br';
	        xhr.open('GET', url, true);
	        xhr.send();
	    }
      
        function parseWeather(data){
            chrome.browserAction.setBadgeText({text:''});
            if(data != null){
                if(data.getElementsByTagName('problem_cause').length > 0){
                    chrome.browserAction.setBadgeText({text:'error'});
                }else{
                    if(localStorage.unit == undefined || localStorage.unit == 'C'){
                        var temp = data.getElementsByTagName('current_conditions')[0].getElementsByTagName('temp_c')[0].getAttribute('data');
                        if(temp != ""){
                            chrome.browserAction.setBadgeText({text:temp + 'ºC'});
                        }
                    }else{
                        var temp = data.getElementsByTagName('current_conditions')[0].getElementsByTagName('temp_f')[0].getAttribute('data');
                        if(temp != ""){
                            chrome.browserAction.setBadgeText({text:temp + 'ºF'});
                        }
                    }
                }
            }
        }
	  
        function getCity(geoPosition){
            var cityName = localStorage.city;
            if(cityName == null || cityName.trim().length == 0){
                if(hasGeoposition()){
                    cityName = ',,,' + localStorage.latitude + ',' + localStorage.longitude;
                }else{
                    navigator.geolocation.getCurrentPosition(discoverPosition);
                }
            }
            return cityName;
        }
	  
        function discoverPosition(position){
            localStorage.latitude = position.coords.latitude * 1000000;
            localStorage.longitude = position.coords.longitude * 1000000;
            updateWeather();
        }
	  
        function hasGeoposition(){
            return (localStorage.latitude != null && localStorage.latitude != "" && localStorage.longitude != null && localStorage.longitude != "");
        }

        updateWeather();
        window.setInterval(updateWeather, 60000);

        function onRequest(request, sender, sendResponse) {
            updateWeather();
        }
	  
        chrome.extension.onRequest.addListener(onRequest);
    </script>
  </body>
</html>
